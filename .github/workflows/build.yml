name: Build Workflow

on:
  workflow_call:
    inputs:
      #variables
      java_version:
        description: "Vers√£o do Java (ex: '17' ou '21')"
        required: false
        type: string
        default: "17"
      app_name:
        required: false
        type: string
        default: "default-app"
      dockerhub_username:
        required: false
        type: string
        default: "postechf57"
      cluster_name:
        required: false
        type: string
        default: "eks-postech-g57"
      region_aws_deploy:
        required: false
        type: string
        default: "us-east-1"
      domain_name:
        required: false
        type: string
        default: "pos-tech-g57-food-app.com.br"
      #runsteps
      run_validation_and_lint:
        description: "Executar valida√ß√£o e linting (mvn verify)"
        required: false
        type: boolean
        default: true
      run_build_and_test:
        description: "Executar build e testes"
        required: false
        type: boolean
        default: true
#      run_unit_test:
#        description: "Executar Testes Unit√°rios"
#        required: false
#        type: boolean
#        default: true
    #secrets
    secrets:
      DOCKERHUB_TOKEN:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      JWT_TOKEN_PIX_APPLICATION_PAYMENT:
        required: false
      JWT_SECRET:
        required: false
      CLOUDFLARE_EDIT_ZONE_DNS_KEY:
        required: false


jobs:
  validation-and-lint:
    name: Validation & Code Quality
    runs-on: ubuntu-latest
    if: inputs.run_validation_and_lint
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verify Required Variables and Secrets
        run: |
          echo "üîç Verificando vari√°veis e secrets necess√°rios..."

          # prefer inputs, fallback para repository vars
          APP_NAME="${{ inputs.app_name }}"
          if [ -z "$APP_NAME" ]; then
            APP_NAME="${{ vars.APP_NAME }}"
          fi

          DOCKERHUB_USERNAME="${{ inputs.dockerhub_username }}"
          if [ -z "$DOCKERHUB_USERNAME" ]; then
            DOCKERHUB_USERNAME="${{ vars.DOCKERHUB_USERNAME }}"
          fi

          CLUSTER_NAME="${{ inputs.cluster_name }}"
          if [ -z "$CLUSTER_NAME" ]; then
            CLUSTER_NAME="${{ vars.CLUSTER_NAME }}"
          fi

          REGION_AWS_DEPLOY="${{ inputs.region_aws_deploy }}"
          if [ -z "$REGION_AWS_DEPLOY" ]; then
            REGION_AWS_DEPLOY="${{ vars.REGION_AWS_DEPLOY }}"
          fi

          DOMAIN_NAME="${{ inputs.domain_name }}"
          if [ -z "$DOMAIN_NAME" ]; then
            DOMAIN_NAME="${{ vars.DOMAIN_NAME }}"
          fi

          echo "üìã Verificando vari√°veis..."
          MISSING_VARS=()
          if [ -z "$APP_NAME" ]; then MISSING_VARS+=("APP_NAME"); else echo "‚úÖ APP_NAME: $APP_NAME"; fi
          if [ -z "$DOCKERHUB_USERNAME" ]; then MISSING_VARS+=("DOCKERHUB_USERNAME"); else echo "‚úÖ DOCKERHUB_USERNAME: $DOCKERHUB_USERNAME"; fi
          if [ -z "$CLUSTER_NAME" ]; then MISSING_VARS+=("CLUSTER_NAME"); else echo "‚úÖ CLUSTER_NAME: $CLUSTER_NAME"; fi
          if [ -z "$REGION_AWS_DEPLOY" ]; then MISSING_VARS+=("REGION_AWS_DEPLOY"); else echo "‚úÖ REGION_AWS_DEPLOY: $REGION_AWS_DEPLOY"; fi
          if [ -z "$DOMAIN_NAME" ]; then MISSING_VARS+=("DOMAIN_NAME"); else echo "‚úÖ DOMAIN_NAME: $DOMAIN_NAME"; fi

          echo "üîê Verificando secrets..."
          MISSING_SECRETS=()
          DOCKERHUB_TOKEN="${{ secrets.DOCKERHUB_TOKEN }}"
          if [ -z "$DOCKERHUB_TOKEN" ]; then MISSING_SECRETS+=("DOCKERHUB_TOKEN"); else echo "‚úÖ DOCKERHUB_TOKEN: [REDACTED]"; fi

          AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then MISSING_SECRETS+=("AWS_ACCESS_KEY_ID"); else echo "‚úÖ AWS_ACCESS_KEY_ID: [REDACTED]"; fi

          AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then MISSING_SECRETS+=("AWS_SECRET_ACCESS_KEY"); else echo "‚úÖ AWS_SECRET_ACCESS_KEY: [REDACTED]"; fi

          JWT_TOKEN_PIX_APPLICATION_PAYMENT="${{ secrets.JWT_TOKEN_PIX_APPLICATION_PAYMENT }}"
          if [ -z "$JWT_TOKEN_PIX_APPLICATION_PAYMENT" ]; then MISSING_SECRETS+=("JWT_TOKEN_PIX_APPLICATION_PAYMENT"); else echo "‚úÖ JWT_TOKEN_PIX_APPLICATION_PAYMENT: [REDACTED]"; fi

          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          if [ -z "$JWT_SECRET" ]; then MISSING_SECRETS+=("JWT_SECRET"); else echo "‚úÖ JWT_SECRET: [REDACTED]"; fi

          CLOUDFLARE_EDIT_ZONE_DNS_KEY="${{ secrets.CLOUDFLARE_EDIT_ZONE_DNS_KEY }}"
          if [ -z "$CLOUDFLARE_EDIT_ZONE_DNS_KEY" ]; then MISSING_SECRETS+=("CLOUDFLARE_EDIT_ZONE_DNS_KEY"); else echo "‚úÖ CLOUDFLARE_EDIT_ZONE_DNS_KEY: [REDACTED]"; fi

          if [ ${#MISSING_VARS[@]} -ne 0 ] || [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo ""
            echo "‚ùå ERRO: Vari√°veis ou secrets obrigat√≥rios n√£o foram encontrados!"
            if [ ${#MISSING_VARS[@]} -ne 0 ]; then
              echo ""
              echo "üìã Vari√°veis faltando:"
              for var in "${MISSING_VARS[@]}"; do
                echo "  - $var"
              done
            fi
            if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
              echo ""
              echo "üîê Secrets faltando:"
              for secret in "${MISSING_SECRETS[@]}"; do
                echo "  - $secret"
              done
            fi
            exit 1
          else
            echo ""
            echo "‚úÖ Todas as vari√°veis e secrets necess√°rios est√£o configurados!"
            echo ""
          fi
      - name: Lint Dockerfile
        run: |
          echo "üîç Verificando qualidade do Dockerfile..."
          
           # Verificar se o Dockerfile existe
           if [ ! -f "Dockerfile" ]; then
             echo "‚ùå ERRO: Dockerfile n√£o encontrado no reposit√≥rio"
             exit 1
           fi
          
           echo "‚úÖ Dockerfile encontrado"
          
           # Instalar hadolint se n√£o estiver dispon√≠vel
           if ! command -v hadolint &> /dev/null; then
             echo "üì¶ Instalando hadolint..."
             wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
             chmod +x hadolint
             sudo mv hadolint /usr/local/bin/
           fi
          
           echo "üîç Executando lint no Dockerfile..."
           hadolint Dockerfile 




  build_and_test:
    needs: validation-and-lint
    if: ${{ inputs.run_build_and_test }}
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.set-output.outputs.build_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}
          cache: maven
#      - name: Cache Maven repository
#        uses: actions/cache@v4
#        with:
#          path: ~/.m2/repository
#          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#              ${{ runner.os }}-m2-
      - name: Run build and Tests
        if: inputs.run_build_and_test
#        id: run-build
        run: |
          mvn -B verify
#          set -o pipefail
#          echo "Executing: mvn clean package -DskipTests"
#          mvn clean package -DskipTests
#            EXIT_CODE=$?
#            if [ $EXIT_CODE -eq 0 ]; then
#              echo "build_status=success" >> $GITHUB_OUTPUT
#            else
#              echo "build_status=failure" >> $GITHUB_OUTPUT
#              exit $EXIT_CODE
#            fi
#      - name: Build whithout Tests
#        if: inputs.run_build_and_test && !inputs.run_unit_test
#        run: |
#          mvn -B package -DskipTests
#      - name: Set job output
#        id: set-output
#        run: |
#          # output already written to GITHUB_OUTPUT by step above; ensure it's present
#          echo "build_status=${{ steps.run-build.outputs.build_status || 'success' }}" >> $GITHUB_OUTPUT
#
#  unit_test:
#    if: ${{ inputs.run_unit_test }}
#    runs-on: ubuntu-latest
#    needs: [ validation-and-lint, build]
#    outputs:
#      test_status: ${{ steps.set-output.outputs.test_status }}
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#
#      - name: Setup Java
#        uses: actions/setup-java@v4
#        with:
#          distribution: temurin
#          java-version: ${{ inputs.java_version }}
#          cache: maven
#
#      - name: Cache Maven repository
#        uses: actions/cache@v4
#        with:
#          path: ~/.m2/repository
#          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#          restore-keys: |
#            ${{ runner.os }}-m2-
#
#      - name: Run tests
#        id: run-tests
#        run: |
#          set -o pipefail
#          echo "Executing: mvn test"
#          mvn test
#          EXIT_CODE=$?
#          if [ $EXIT_CODE -eq 0 ]; then
#            echo "test_status=success" >> $GITHUB_OUTPUT
#          else
#            echo "test_status=failure" >> $GITHUB_OUTPUT
#            exit $EXIT_CODE
#          fi
#
#      - name: Set job output
#        id: set-output
#        run: |
#          echo "test_status=${{ steps.run-unit_test.outputs.test_status || 'success' }}" >> $GITHUB_OUTPUT

      - name: Gerar relat√≥rio Jacoco
        if: inputs.run_build_and_test
        run: mvn jacoco:report

      - name: Generate Jacoco Badge
        id: jacoco
        if: inputs.run_build_and_test
        uses: cicirello/jacoco-badge-generator@v2.0.1
      - name: Log coverage percentage
        if: inputs.run_build_and_test
        run: |
          echo "Coverage percentage: ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage: ${{ steps.jacoco.outputs.branches }}"

      - name: Upload Jacoco coverage report
        if: inputs.run_build_and_test
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      - name: Upload build artifacts for Sonar
        if: inputs.run_build_and_test
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/