name: Build Workflow

on:
  workflow_call:
    inputs:
      app_name:
        required: false
        type: string
        default: 'default-app'
      dockerhub_username:
        required: false
        type: string
        default: 'postechf57'
      cluster_name:
        required: false
        type: string
        default: 'eks-postech-g57'
      region_aws_deploy:
        required: false
        type: string
        default: 'us-east-1'
      domain_name:
        required: false
        type: string
        default: 'pos-tech-g57-food-app.com.br'
      run_validation_and_lint:
        required: true
        type: boolean
      run_build:
        required: true
        type: boolean
      run_unit_test:
        required: true
        type: boolean

jobs:
  validation-and-lint:
    name: Validation & Code Quality
    runs-on: ubuntu-latest
    if: inputs.run_validation_and_lint
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Verify Required Variables and Secrets
        run: |
          echo "üîç Verificando vari√°veis e secrets necess√°rios..."
          
          # Lista de vari√°veis obrigat√≥rias
          REQUIRED_VARS=(
            "APP_NAME"
            "DOCKERHUB_USERNAME" 
            "CLUSTER_NAME"
            "REGION_AWS_DEPLOY"
            "DOMAIN_NAME"
          )
          
          # Lista de secrets obrigat√≥rios
          REQUIRED_SECRETS=(
            "DOCKERHUB_TOKEN"
            "AWS_ACCESS_KEY_ID"
            "AWS_SECRET_ACCESS_KEY"
            "AWS_ACCESS_KEY"
            "AWS_SECRET_KEY"
            "JWT_TOKEN_PIX_APPLICATION_PAYMENT"
            "JWT_SECRET"
            "CLOUDFLARE_EDIT_ZONE_DNS_KEY"
          )
          
          echo "üìã Verificando vari√°veis..."
          MISSING_VARS=()
          for var in "${REQUIRED_VARS[@]}"; do
            case $var in
              "APP_NAME")
                if [ -z "${{ vars.APP_NAME }}" ]; then
                  MISSING_VARS+=("$var")
                else
                  echo "‚úÖ $var: ${{ vars.APP_NAME }}"
                fi
                ;;
              "DOCKERHUB_USERNAME")
                if [ -z "${{ vars.DOCKERHUB_USERNAME }}" ]; then
                  MISSING_VARS+=("$var")
                else
                  echo "‚úÖ $var: ${{ vars.DOCKERHUB_USERNAME }}"
                fi
                ;;
              "CLUSTER_NAME")
                if [ -z "${{ vars.CLUSTER_NAME }}" ]; then
                  MISSING_VARS+=("$var")
                else
                  echo "‚úÖ $var: ${{ vars.CLUSTER_NAME }}"
                fi
                ;;
              "REGION_AWS_DEPLOY")
                if [ -z "${{ vars.REGION_AWS_DEPLOY }}" ]; then
                  MISSING_VARS+=("$var")
                else
                  echo "‚úÖ $var: ${{ vars.REGION_AWS_DEPLOY }}"
                fi
                ;;
              "DOMAIN_NAME")
                if [ -z "${{ vars.DOMAIN_NAME }}" ]; then
                  MISSING_VARS+=("$var")
                else
                  echo "‚úÖ $var: ${{ vars.DOMAIN_NAME }}"
                fi
                ;;
            esac
          done
          
          echo "üîê Verificando secrets..."
          MISSING_SECRETS=()
          for secret in "${REQUIRED_SECRETS[@]}"; do
            case $secret in
              "DOCKERHUB_TOKEN")
                if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
              "AWS_ACCESS_KEY_ID")
                if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
              "AWS_SECRET_ACCESS_KEY")
                if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
              "JWT_TOKEN_PIX_APPLICATION_PAYMENT")
                if [ -z "${{ secrets.JWT_TOKEN_PIX_APPLICATION_PAYMENT }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
              "JWT_SECRET")
                if [ -z "${{ secrets.JWT_SECRET }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
              "CLOUDFLARE_EDIT_ZONE_DNS_KEY")
                if [ -z "${{ secrets.CLOUDFLARE_EDIT_ZONE_DNS_KEY }}" ]; then
                  MISSING_SECRETS+=("$secret")
                else
                  echo "‚úÖ $secret: [REDACTED]"
                fi
                ;;
            esac
          done
          
          # Verificar se h√° vari√°veis ou secrets faltando
          if [ ${#MISSING_VARS[@]} -ne 0 ] || [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
            echo ""
            echo "‚ùå ERRO: Vari√°veis ou secrets obrigat√≥rios n√£o foram encontrados!"
          
            if [ ${#MISSING_VARS[@]} -ne 0 ]; then
              echo ""
              echo "üìã Vari√°veis faltando:"
              for var in "${MISSING_VARS[@]}"; do
                echo "  - $var"
              done
              echo ""
              echo "Para adicionar vari√°veis:"
              echo "  1. V√° para Settings > Secrets and variables > Actions"
              echo "  2. Na aba 'Variables', clique em 'New repository variable'"
              echo "  3. Adicione cada vari√°vel listada acima"
            fi
          
            if [ ${#MISSING_SECRETS[@]} -ne 0 ]; then
              echo ""
              echo "üîê Secrets faltando:"
              for secret in "${MISSING_SECRETS[@]}"; do
                echo "  - $secret"
              done
            fi
          
            exit 1
          else
            echo ""
            echo "‚úÖ Todas as vari√°veis e secrets necess√°rios est√£o configurados!"
            echo ""
          fi
      - name: Lint Dockerfile
        run: |
          echo "üîç Verificando qualidade do Dockerfile..."
          
           # Verificar se o Dockerfile existe
           if [ ! -f "Dockerfile" ]; then
             echo "‚ùå ERRO: Dockerfile n√£o encontrado no reposit√≥rio"
             exit 1
           fi
          
           echo "‚úÖ Dockerfile encontrado"
          
           # Instalar hadolint se n√£o estiver dispon√≠vel
           if ! command -v hadolint &> /dev/null; then
             echo "üì¶ Instalando hadolint..."
             wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
             chmod +x hadolint
             sudo mv hadolint /usr/local/bin/
           fi
          
           echo "üîç Executando lint no Dockerfile..."
           hadolint Dockerfile 




  build:
    runs-on: ubuntu-latest
    needs: validation-and-lint
    if: inputs.run_build
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build Maven project
        run: mvn clean package -DskipTests

  unit-test:
    runs-on: ubuntu-latest
    needs: build
    if: inputs.run_unit_test
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - run: mvn test

      - name: Gerar relat√≥rio Jacoco
        run: mvn jacoco:report

      - name: Generate Jacoco Badge
        id: jacoco
        uses: cicirello/jacoco-badge-generator@v2.0.1
      - name: Log coverage percentage
        run: |
          echo "Coverage percentage: ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage: ${{ steps.jacoco.outputs.branches }}"

      - name: Upload Jacoco coverage report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/